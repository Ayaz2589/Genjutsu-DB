# Data Model: genjutsu-db

**Feature Branch**: `001-genjutsu-db`
**Date**: 2026-02-19

## Entity Relationship Diagram

```
┌─────────────────────┐
│   GenjutsuClient     │
│─────────────────────│
│ spreadsheetId       │
│ auth (token/fn)     │
│ apiKey?             │
│ schemas: Map<K,S>   │
├─────────────────────┤
│ repo<K>()           │──────┐
│ batchSync()         │      │
│ ensureSchema()      │      │
│ applyFormatting()   │      │
│ migrate()           │      │
│ createSpreadsheet() │      │
└─────────────────────┘      │
                              │
                    ┌─────────▼──────────┐
                    │   Repository<T>     │
                    │────────────────────│
                    │ schema: SheetSchema │
                    ├────────────────────┤
                    │ create(record)     │
                    │ findById(id)       │
                    │ findMany(filter?)  │
                    │ update(id, Δ)      │
                    │ delete(id)         │
                    │ readAll()          │
                    │ writeAll(records)  │
                    │ append(records)    │
                    └────────────────────┘

┌──────────────────┐       ┌──────────────────┐
│  ModelDefinition  │──────▶│   SheetSchema<T>  │
│──────────────────│       │──────────────────│
│ sheetName        │       │ sheetName        │
│ fields: FieldMap │       │ headers[]        │
│                  │       │ readRange        │
│                  │       │ writeRange       │
│                  │       │ clearRange       │
│                  │       │ parseRow()       │
│                  │       │ toRow()          │
│                  │       │ validate?()      │
│                  │       │ formatting?      │
└──────────────────┘       └──────────────────┘

┌──────────────────┐       ┌──────────────────────┐
│    Migration      │──────▶│   MigrationContext     │
│──────────────────│       │──────────────────────│
│ version: number  │       │ createSheet(name)    │
│ name: string     │       │ addColumn(sheet,col) │
│ up(ctx)          │       │ removeColumn(sheet,i)│
│                  │       │ renameColumn(s,i,n)  │
│                  │       │ renameSheet(old,new) │
└──────────────────┘       └──────────────────────┘

┌──────────────────┐
│  GenjutsuError    │
│──────────────────│
│ kind: ErrorKind  │
│ message: string  │
│ cause?: unknown  │
│ retryAfterMs?    │
│ validationIssues?│
│ migrationVersion?│
│ migrationName?   │
└──────────────────┘
```

## Entities

### 1. GenjutsuClient

The main client object. Created via factory function. Holds connection state and provides access to all operations.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| spreadsheetId | string | Yes | Google Spreadsheet ID (extracted from URL if needed) |
| auth | string \| () => Promise\<string\> | No* | OAuth token or async provider. Required for writes. |
| apiKey | string | No* | API key for public sheet reads. |
| schemas | Record\<string, SheetSchema\> | Yes | Registered model schemas keyed by name |

*At least one of `auth` or `apiKey` must be provided.

**Validation Rules:**
- `spreadsheetId` must be non-empty
- At least one schema must be registered
- No two schemas may share the same `sheetName`
- No schema may use the reserved name `_genjutsu_migrations`

---

### 2. SheetSchema\<T\>

Defines how an entity type maps to a Google Sheet tab. Can be created manually or generated by `defineModel()`.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| sheetName | string | Yes | Sheet tab name |
| headers | string[] | Yes | Column header names in order |
| readRange | string | Yes | A1 notation range for reads (e.g., "Contacts!A1:D") |
| writeRange | string | Yes | A1 notation range for writes |
| clearRange | string | Yes | A1 notation range for clearing (excludes header row) |
| parseRow | (row: unknown[], index: number) => T \| null | Yes | Deserializes a sheet row to an entity |
| toRow | (entity: T) => unknown[] | Yes | Serializes an entity to a sheet row |
| validate | (entity: T) => void | No | Throws on invalid entity (called before writes) |
| appendSupported | boolean | No | Whether append operations are allowed (default: true) |
| formatting | FormattingRule[] | No | Column/cell formatting rules |
| headerFormatting | HeaderFormat | No | Header row formatting |
| primaryKey | string | No | Name of the primary key field (for CRUD operations) |
| fields | FieldDefinition[] | No | Field definitions (present when created via defineModel) |
| relations | RelationDefinition[] | No | Foreign key relationships (present when fields have references) |

**Validation Rules:**
- `sheetName` must be non-empty
- `headers` must have at least one entry
- `headers` must have no duplicates
- If `primaryKey` is set, it must match one of the `headers`

---

### 3. FieldDefinition

Describes a single column/field in a model. Created via the `field` builder.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | string | Yes | Column header name |
| type | "string" \| "number" \| "date" \| "boolean" | Yes | Data type |
| isPrimaryKey | boolean | No | Whether this field is the primary key (default: false) |
| isOptional | boolean | No | Whether null is allowed (default: false) |
| defaultValue | T | No | Default value when not provided on create |
| references | { model: string, field: string } | No | Foreign key reference |

**Validation Rules:**
- Exactly one field per model may be marked as primary key
- `defaultValue` type must match `type`
- If `references` is set, the target model and field must exist at registration time
- `date` type fields store ISO 8601 date strings (YYYY-MM-DD)

---

### 4. RelationDefinition

Describes a foreign key relationship between two models. Derived from field-level `references` declarations.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| sourceField | string | Yes | Field name on the source model |
| targetModel | string | Yes | Name of the referenced model |
| targetField | string | Yes | Field name on the target model (usually its primary key) |
| type | "many-to-one" | Yes | Relationship type (only many-to-one supported) |

**Validation Rules:**
- `targetModel` must be a registered schema
- `targetField` must be the primary key of the target model

---

### 5. Repository\<T\>

Bound CRUD operations for a single model. Created automatically from a SheetSchema.

| Method | Signature | Description |
|--------|-----------|-------------|
| create | (record: CreateInput\<T\>) => Promise\<T\> | Validate, check duplicate PK, append to sheet |
| findById | (id: string \| number) => Promise\<T \| null\> | Read all, find by PK |
| findMany | (filter?: (item: T) => boolean, options?: FindOptions) => Promise\<T[]\> | Read all, filter in-memory |
| update | (id: string \| number, changes: Partial\<T\>) => Promise\<T\> | Read all, merge changes, validate, write all |
| delete | (id: string \| number) => Promise\<void\> | Read all, filter out target, write all |
| readAll | (options?: ReadOptions) => Promise\<T[]\> | Read entire sheet, parse all rows |
| writeAll | (records: T[]) => Promise\<void\> | Clear + write all records |
| append | (records: T[]) => Promise\<void\> | Append records without clearing |

**FindOptions:**
| Field | Type | Description |
|-------|------|-------------|
| include | Record\<string, true\> | Eager load related models |

**ReadOptions:**
| Field | Type | Description |
|-------|------|-------------|
| include | Record\<string, true\> | Eager load related models |

**WriteOptions:**
| Field | Type | Description |
|-------|------|-------------|
| skipFkValidation | boolean | Skip foreign key validation (default: false) |

---

### 6. Migration

A versioned schema change operation.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| version | number | Yes | Sequential version number (must be unique) |
| name | string | Yes | Human-readable migration name |
| up | (ctx: MigrationContext) => Promise\<void\> | Yes | Function that applies the migration |

**Validation Rules:**
- `version` must be a positive integer
- `version` must be unique across all migrations
- Migrations must be provided in ascending version order

---

### 7. MigrationContext

Passed to migration `up()` functions. Provides structural modification operations.

| Method | Signature | Description |
|--------|-----------|-------------|
| createSheet | (name: string) => Promise\<void\> | Create a new sheet tab |
| addColumn | (sheet: string, column: string, afterIndex?: number) => Promise\<void\> | Insert a column with header |
| removeColumn | (sheet: string, columnIndex: number) => Promise\<void\> | Delete a column by index |
| renameColumn | (sheet: string, columnIndex: number, newName: string) => Promise\<void\> | Rename a column header |
| renameSheet | (oldName: string, newName: string) => Promise\<void\> | Rename a sheet tab |

---

### 8. MigrationRecord

Stored in the `_genjutsu_migrations` sheet tab. Tracks which migrations have been applied.

| Field | Type | Description |
|-------|------|-------------|
| version | number | Migration version number |
| name | string | Migration name |
| applied_at | string | ISO 8601 timestamp of when the migration was applied |

---

### 9. GenjutsuError

Typed error with discriminated union on `kind`.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| kind | GenjutsuErrorKind | Yes | Error category for pattern matching |
| message | string | Yes | Human-readable error message |
| cause | unknown | No | Original error that caused this one |
| retryAfterMs | number | No | Milliseconds to wait (RATE_LIMIT only) |
| validationIssues | ValidationIssue[] | No | Field-level issues (VALIDATION_ERROR only) |
| migrationVersion | number | No | Failed migration version (MIGRATION_ERROR only) |
| migrationName | string | No | Failed migration name (MIGRATION_ERROR only) |

**GenjutsuErrorKind (8 values):**
- `AUTH_ERROR` — 401 / token invalid
- `PERMISSION_ERROR` — 403 / insufficient access
- `RATE_LIMIT` — 429 / rate limited
- `NETWORK_ERROR` — fetch failed
- `VALIDATION_ERROR` — field/FK/PK validation failed
- `SCHEMA_ERROR` — invalid model definition
- `MIGRATION_ERROR` — migration execution failed
- `API_ERROR` — other HTTP errors

---

### 10. ValidationIssue

Describes a single field-level validation failure.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| field | string | Yes | Name of the field that failed validation |
| message | string | Yes | Description of the validation failure |
| value | unknown | No | The invalid value that was provided |

---

### 11. FormattingRule

Defines formatting for a range of cells in a sheet.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| startCol | number | Yes | Start column index (0-based) |
| endCol | number | Yes | End column index (exclusive) |
| startRow | number | No | Start row index (default: 1, skips header) |
| endRow | number | No | End row index (default: 10000) |
| bold | boolean | No | Bold text |
| fontSize | number | No | Font size |
| horizontalAlignment | "LEFT" \| "CENTER" \| "RIGHT" | No | Text alignment |
| numberFormat | { type: string, pattern?: string } | No | Number/date format |

---

### 12. HeaderFormat

Defines formatting for the header row of a sheet.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| bold | boolean | No | Bold header text |
| fontSize | number | No | Header font size |
| horizontalAlignment | "LEFT" \| "CENTER" \| "RIGHT" | No | Header text alignment |

---

## State Transitions

### Connection States

```
                    ┌──────────┐
         ┌─────────│  NO_AUTH  │
         │         └──────────┘
         │              │ apiKey provided
         │              ▼
         │         ┌───────────┐
         │         │ READ_ONLY │ ──── write attempt ──── ▶ PERMISSION_ERROR
         │         └───────────┘
         │
         │ auth provided
         ▼
    ┌──────────┐
    │ FULL_AUTH │ ──── 401 ──── ▶ retry with fresh token ──── 401 ──── ▶ AUTH_ERROR
    └──────────┘
         │
         │ 403
         ▼
    ┌──────────┐
    │ READ_ONLY│ ──── write attempt ──── ▶ PERMISSION_ERROR
    └──────────┘
```

### Migration States

```
    ┌─────────┐
    │ PENDING │ ──── up() succeeds ──── ▶ ┌─────────┐
    └─────────┘                            │ APPLIED │ (recorded in _genjutsu_migrations)
         │                                 └─────────┘
         │ up() throws
         ▼
    ┌──────────┐
    │  FAILED  │ (NOT recorded, will retry on next migrate() call)
    └──────────┘
```

### Write Operation States

```
    ┌──────────┐
    │ VALIDATE │ ──── validation fails ──── ▶ VALIDATION_ERROR (no API call made)
    └──────────┘
         │ passes
         ▼
    ┌──────────┐
    │ FK_CHECK │ ──── FK invalid ──── ▶ VALIDATION_ERROR (no write made)
    └──────────┘
         │ passes (or skipped)
         ▼
    ┌──────────┐
    │ PK_CHECK │ ──── duplicate PK ──── ▶ VALIDATION_ERROR (create only)
    └──────────┘
         │ passes
         ▼
    ┌──────────┐
    │  WRITE   │ ──── API error ──── ▶ AUTH/RATE_LIMIT/NETWORK/API_ERROR
    └──────────┘
         │ succeeds
         ▼
    ┌──────────┐
    │ COMPLETE │
    └──────────┘
```
